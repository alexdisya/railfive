<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MoltArena Bot Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <style>
    body { background: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; }
    #logs { background: #161b22; border: 1px solid #30363d; height: 50vh; overflow-y: auto; padding: 15px; font-family: monospace; white-space: pre-wrap; }
    .card-battle { background: linear-gradient(135deg, #1f2937, #111827); border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
    .card-header { background: #21262d; border-bottom: 1px solid #30363d; }
    .status-active { color: #56d364; }
    .status-voting { color: #f6c443; }
    .status-completed { color: #d29922; }
    .btn-start { background: #238636; border: none; }
    .btn-stop { background: #da3633; border: none; }
  </style>
</head>
<body class="container py-4">

  <h2 class="text-center mb-4 text-white">MoltArena Auto Battle Bot</h2>

  <!-- Form Setting -->
  <div class="card mb-4">
    <div class="card-header">Pengaturan Bot</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">API Key</label>
          <input type="text" id="api_key" class="form-control" placeholder="sk-..." value="{{ config.api_key }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Agent ID</label>
          <input type="text" id="agent_id" class="form-control" placeholder="78ea40fa-..." value="{{ config.agent_id }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Cooldown (detik)</label>
          <input type="number" id="cooldown" class="form-control" value="{{ config.cooldown_seconds }}" min="30">
        </div>
        <div class="col-12 col-md-8 d-flex align-items-end gap-2">
          <button id="btn-save" class="btn btn-primary">Simpan Config</button>
          <button id="btn-start" class="btn btn-start text-white {% if config.running %}disabled{% endif %}">START BOT</button>
          <button id="btn-stop" class="btn btn-stop text-white {% if not config.running %}disabled{% endif %}">STOP BOT</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Log -->
  <div class="card card-battle mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Live Battle Status & Log</span>
      <span id="bot-status" class="badge bg-secondary">Stopped</span>
    </div>
    <div id="logs" class="card-body"></div>
  </div>

  <script>
    const socket = io();
    const logs = document.getElementById('logs');
    const statusBadge = document.getElementById('bot-status');

    socket.on('log', (data) => {
      logs.innerHTML += data.message + '\n';
      logs.scrollTop = logs.scrollHeight;
    });

    // Simpan config
    document.getElementById('btn-save').onclick = () => {
      fetch('/api/update_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          api_key: document.getElementById('api_key').value,
          agent_id: document.getElementById('agent_id').value,
          cooldown: document.getElementById('cooldown').value
        })
      }).then(r => r.json()).then(d => alert('Config disimpan!'));
    };

    // Start
    document.getElementById('btn-start').onclick = () => {
      fetch('/api/start_bot', {method: 'POST'})
        .then(r => r.json())
        .then(d => {
          if (d.status === 'started') {
            statusBadge.textContent = 'Running';
            statusBadge.className = 'badge bg-success';
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
          } else {
            alert(d.message || 'Gagal start');
          }
        });
    };

    // Stop
    document.getElementById('btn-stop').onclick = () => {
      fetch('/api/stop_bot', {method: 'POST'})
        .then(r => r.json())
        .then(d => {
          if (d.status === 'stopping') {
            statusBadge.textContent = 'Stopping...';
            statusBadge.className = 'badge bg-warning';
            setTimeout(() => {
              statusBadge.textContent = 'Stopped';
              statusBadge.className = 'badge bg-secondary';
              document.getElementById('btn-start').disabled = false;
              document.getElementById('btn-stop').disabled = true;
            }, 3000);
          }
        });
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>